---
title: "Gestione del contesto del servizio dati (WCF Data Services) | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-oob"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
caps.latest.revision: 6
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 6
---
# Gestione del contesto del servizio dati (WCF Data Services)
La classe <xref:System.Data.Services.Client.DataServiceContext> incapsula operazioni supportate su un servizio dati specificato.  Sebbene i servizi [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] siano senza stato, non lo è il contesto.  È pertanto possibile usare la classe <xref:System.Data.Services.Client.DataServiceContext> per mantenere lo stato nel client tra le interazioni con il servizio dati in modo da supportare funzionalità quali la gestione di modifiche.  Questa classe consente inoltre di gestire le identità e di rilevare le modifiche.  
  
## Risoluzione di identità e opzioni di unione  
 Quando viene eseguito un oggetto <xref:System.Data.Services.Client.DataServiceQuery%601>, le entità nel feed di risposta vengono materializzate in oggetti.  Per altre informazioni, vedere [Materializzazione di oggetti](../../../../docs/framework/data/wcf/object-materialization-wcf-data-services.md).  La modalità di materializzazione in oggetti delle voci presenti in un messaggio di risposta si basa sulla risoluzione di identità e dipende dall'opzione di unione con cui è stata eseguita la query.  Quando più query o richieste di caricamento vengono eseguite nell'ambito di un solo <xref:System.Data.Services.Client.DataServiceContext>, il client [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] rileva solo un'istanza di un oggetto con un valore della chiave specifico.  Questa chiave, usata per eseguire la risoluzione di identità, identifica in modo univoco un'entità.  
  
 Per impostazione predefinita, il client materializza una sola voce del feed di risposta in un oggetto delle entità non ancora rilevate da <xref:System.Data.Services.Client.DataServiceContext>.  In altre parole, non vengono sovrascritte le modifiche agli oggetti già presenti nella cache.  Questo comportamento viene controllato specificando un valore <xref:System.Data.Services.Client.MergeOption> per le query e le operazioni di caricamento.  Questa opzione viene specificata impostando la proprietà <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> su <xref:System.Data.Services.Client.DataServiceContext>.  Il valore dell'opzione di unione predefinita è <xref:System.Data.Services.Client.MergeOption>.  Questo valore consente di materializzare gli oggetti delle entità non ancora rilevate. Ciò significa che gli oggetti esistenti non vengono sovrascritti.  Un'altra modalità per impedire che gli oggetti sul client vengano sovrascritti dagli aggiornamenti del servizio dati consiste nello specificare <xref:System.Data.Services.Client.MergeOption>.  Quando si specifica <xref:System.Data.Services.Client.MergeOption>, i valori degli oggetti nel client vengono sostituiti dai valori più recenti delle voci presenti nel feed di risposta, anche se a tali oggetti sono già state apportate modifiche.  Quando viene usata un'opzione di unione <xref:System.Data.Services.Client.MergeOption>, <xref:System.Data.Services.Client.DataServiceContext> non può inviare al servizio dati le modifiche apportate agli oggetti del client.  Con questa opzione le modifiche vengono sempre sovrascritte dai valori del servizio dati.  
  
## Gestione della concorrenza  
 [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] supporta la concorrenza ottimistica che consente al servizio dati il rilevamento dei conflitti di aggiornamento.  È possibile configurare il provider del servizio dati in modo che il servizio dati verifichi le modifiche alle entità tramite un token di concorrenza.  Il token è costituito da una o più proprietà di un tipo di entità che vengono convalidate dal servizio dati per determinare se una risorsa è stata modificata.  I token di concorrenza inclusi nell'intestazione eTag delle richieste al servizio dati e delle relative risposte vengono gestiti automaticamente dal client [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]. Per ulteriori informazioni, vedere [Aggiornamento del servizio dati](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md).  
  
 <xref:System.Data.Services.Client.DataServiceContext> rileva le modifiche apportate agli oggetti segnalati manualmente tramite <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A> e <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A> o tramite un oggetto <xref:System.Data.Services.Client.DataServiceCollection%601>.  Quando si chiama il metodo <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, il client restituisce le modifiche al servizio dati.  Quando le modifiche del client sono in conflitto con quelle del servizio dati, è possibile che l'esecuzione del metodo <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> non riesca.  Quando si verifica ciò, è necessario eseguire una nuova query per la risorsa dell'entità per ricevere i dati dell'aggiornamento.  Per sovrascrivere le modifiche nel servizio dati, eseguire la query usando l'opzione di unione <xref:System.Data.Services.Client.MergeOption>.  Quando si chiama nuovamente <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, le modifiche salvate sul client vengono salvate in modo permanente nel servizio dati e rimangono in tale posizione fino a quando le altre modifiche non vengono apportate alla risorsa nel servizio dati.  
  
## Salvataggio delle modifiche  
 Le modifiche vengono rilevate nell'istanza di <xref:System.Data.Services.Client.DataServiceContext>, ma non vengono inviate immediatamente al server.  Dopo aver apportato le modifiche necessarie per un'attività specificata, chiamare <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> per inviare tutte le modifiche al servizio dati.  Un oggetto <xref:System.Data.Services.Client.DataServiceResponse> verrà restituito al complemento dell'operazione <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  L'oggetto <xref:System.Data.Services.Client.DataServiceResponse> include una sequenza di oggetti <xref:System.Data.Services.Client.OperationResponse> che a loro volta contengono una sequenza di istanze di <xref:System.Data.Services.Client.EntityDescriptor> o <xref:System.Data.Services.Client.LinkDescriptor> che rappresentano le modifiche persistenti o tentate.  Quando un'entità viene creata o modificata nel servizio dati, in <xref:System.Data.Services.Client.EntityDescriptor> è presente un riferimento all'entità aggiornata, inclusi i valori di proprietà generati dal server, ad esempio il valore `ProductID` generato nell'esempio precedente.  Nella libreria client l'oggetto [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] viene aggiornato automaticamente in modo da impostare i nuovi valori.  
  
 Per le operazioni di inserimento e aggiornamento completate correttamente, la proprietà di stato dell'oggetto <xref:System.Data.Services.Client.EntityDescriptor> o <xref:System.Data.Services.Client.LinkDescriptor> associato all'operazione viene impostata su <xref:System.Data.Services.Client.EntityStates> e i nuovi valori vengono uniti tramite <xref:System.Data.Services.Client.MergeOption>.  Quando un'operazione di inserimento, aggiornamento o eliminazione non riesce nel servizio dati, lo stato dell'entità rimane invariato rispetto a prima della chiamata del metodo <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> e la proprietà <xref:System.Data.Services.Client.OperationResponse.Error%2A> di <xref:System.Data.Services.Client.OperationResponse> viene impostata su un oggetto <xref:System.Data.Services.Client.DataServiceRequestException> contenente le informazioni sull'errore.  Per altre informazioni, vedere [Aggiornamento del servizio dati](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md).  
  
### Impostazione del metodo HTTP per gli aggiornamenti  
 Per impostazione predefinita, la libreria client .NET Framework invia aggiornamenti alle entità esistenti come richieste MERGE.  Una richiesta MERGE aggiorna le proprietà selezionate dell'entità. Il client tuttavia include sempre tutte le proprietà nella richiesta MERGE, anche le proprietà che non sono modificate.  Il protocollo [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] supporta anche l'invio delle richieste PUT per aggiornare le entità.  In una richiesta PUT, un'entità esistente viene essenzialmente sostituita con una nuova istanza dell'entità con i valori della proprietà dal client.  Per usare richieste PUT, impostare il flag <xref:System.Data.Services.Client.SaveChangesOptions> sull'enumerazione <xref:System.Data.Services.Client.SaveChangesOptions> quando si chiama <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
>  Una richiesta PUT si comporterà in modo diverso da una richiesta MERGE se il client non conosce tutte le proprietà dell'entità.  Questo potrebbe verificarsi quando si proietta un tipo di entità in un nuovo tipo sul client.  Si potrebbe verificare anche quando nuove proprietà sono state aggiunte all'entità nel modello di dati del servizio e la proprietà <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> di <xref:System.Data.Services.Client.DataServiceContext> è impostata su `true` per ignorare tali errori del mapping client.  In questi casi, una richiesta PUT reimposterà qualsiasi proprietà sconosciuta al client sui valori predefiniti.  
  
### POST tunneling  
 Per impostazione predefinita, la libreria client invia richieste di creazione, lettura, aggiornamento ed eliminazione a un servizio [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] tramite i metodi HTTP corrispondenti di POST, GET, PUT\/MERGE\/PATCH e DELETE.  In questo modo vengono conservati i principi di base di REST \(Representational State Transfer\).  Tuttavia, non tutte le implementazioni del server Web supportano il set completo di metodi HTTP.  In alcuni casi, i metodi supportati potrebbero essere limitati solo a GET e POST.  Ciò può verificarsi quando un intermediario, ad esempio un firewall, blocca le richieste con alcuni metodi.  Poiché i metodi GET e POST sono quelli supportati più frequentemente, [!INCLUDE[ssODataShort](../../../../includes/ssodatashort-md.md)] stabilisce una modalità per eseguire tutti i metodi HTTP non supportati tramite una richiesta POST.  Noto come *metodo tunneling* o *POST tunneling*, esso consente a un client di inviare una richiesta POST con il metodo effettivo specificato nell'intestazione `X-HTTP-Method` personalizzata.  Per abilitare il POST tunneling per le richieste, impostare la proprietà <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> nell'istanza di <xref:System.Data.Services.Client.DataServiceContext> su `true`.  
  
## Vedere anche  
 [Libreria client WCF Data Services](../../../../docs/framework/data/wcf/wcf-data-services-client-library.md)   
 [Aggiornamento del servizio dati](../../../../docs/framework/data/wcf/updating-the-data-service-wcf-data-services.md)   
 [Operazioni asincrone](../../../../docs/framework/data/wcf/asynchronous-operations-wcf-data-services.md)   
 [Invio in batch di operazioni](../../../../docs/framework/data/wcf/batching-operations-wcf-data-services.md)