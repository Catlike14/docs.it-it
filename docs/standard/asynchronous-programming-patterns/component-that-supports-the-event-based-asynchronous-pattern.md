---
title: 'Procedura dettagliata: implementazione di un componente che supporta il modello asincrono basato su eventi'
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Event-based Asynchronous Pattern
- ProgressChangedEventArgs class
- BackgroundWorker component
- events [.NET Framework], asynchronous
- Asynchronous Pattern
- AsyncOperationManager class
- threading [.NET Framework], asynchronous features
- components [.NET Framework], asynchronous
- AsyncOperation class
- threading [Windows Forms], asynchronous features
- AsyncCompletedEventArgs class
ms.assetid: 61f676b5-936f-40f6-83ce-f22805ec9c2f
caps.latest.revision: "21"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.openlocfilehash: 150e4b27cc149774895574ddd196de5f9bc2acd8
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 11/21/2017
---
# <a name="walkthrough-implementing-a-component-that-supports-the-event-based-asynchronous-pattern"></a><span data-ttu-id="cb4a8-102">Procedura dettagliata: implementazione di un componente che supporta il modello asincrono basato su eventi</span><span class="sxs-lookup"><span data-stu-id="cb4a8-102">Walkthrough: Implementing a Component That Supports the Event-based Asynchronous Pattern</span></span>
<span data-ttu-id="cb4a8-103">Se si sta scrivendo una classe con alcune operazioni che possono causare ritardi notevoli, è consigliabile assegnandogli funzionalità asincrona implementando il [Panoramica del modello asincrono basato su eventi](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span><span class="sxs-lookup"><span data-stu-id="cb4a8-103">If you are writing a class with some operations that may incur noticeable delays, consider giving it asynchronous functionality by implementing the [Event-based Asynchronous Pattern Overview](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span></span>  
  
 <span data-ttu-id="cb4a8-104">Questa procedura dettagliata viene illustrato come creare un componente che implementa il modello asincrono basato su eventi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-104">This walkthrough illustrates how to create a component that implements the Event-based Asynchronous Pattern.</span></span> <span data-ttu-id="cb4a8-105">Viene implementato utilizzando le classi di supporto dal <xref:System.ComponentModel?displayProperty=nameWithType> spazio dei nomi, che assicura che il componente funzioni correttamente con qualsiasi modello di applicazione, tra cui [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)], Console, applicazioni e le applicazioni Windows Form.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-105">It is implemented using helper classes from the <xref:System.ComponentModel?displayProperty=nameWithType> namespace, which ensures that the component works correctly under any application model, including [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)], Console applications and Windows Forms applications.</span></span> <span data-ttu-id="cb4a8-106">Questo componente è inoltre essere progettato con una <xref:System.Windows.Forms.PropertyGrid> controllo e strumenti di progettazione personalizzate.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-106">This component is also designable with a <xref:System.Windows.Forms.PropertyGrid> control and your own custom designers.</span></span>  
  
 <span data-ttu-id="cb4a8-107">Durante la creazione, si disporrà di un'applicazione che consente di calcolare i numeri primi in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-107">When you are through, you will have an application that computes prime numbers asynchronously.</span></span> <span data-ttu-id="cb4a8-108">L'applicazione disporrà di un thread dell'interfaccia utente principale e un thread per ogni calcolo dei numeri primi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-108">Your application will have a main user interface (UI) thread and a thread for each prime number calculation.</span></span> <span data-ttu-id="cb4a8-109">Anche se il test se è un numero elevato primi possono richiedere una notevole quantità di tempo, non verrà interrotto il thread dell'interfaccia utente principale per questo ritardo e il form sarà reattivo durante i calcoli.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-109">Although testing whether a large number is prime can take a noticeable amount of time, the main UI thread will not be interrupted by this delay, and the form will be responsive during the calculations.</span></span> <span data-ttu-id="cb4a8-110">Sarà in grado di eseguire molti calcoli desiderato simultaneamente e in modo selettivo annullare i calcoli in sospeso.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-110">You will be able to run as many calculations as you like concurrently and selectively cancel pending calculations.</span></span>  
  
 <span data-ttu-id="cb4a8-111">Le attività illustrate nella procedura dettagliata sono le seguenti:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-111">Tasks illustrated in this walkthrough include:</span></span>  
  
-   <span data-ttu-id="cb4a8-112">Creazione del componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-112">Creating the Component</span></span>  
  
-   <span data-ttu-id="cb4a8-113">Definizione di delegati e gli eventi asincroni pubblici</span><span class="sxs-lookup"><span data-stu-id="cb4a8-113">Defining Public Asynchronous Events and Delegates</span></span>  
  
-   <span data-ttu-id="cb4a8-114">Definizione di delegati privati</span><span class="sxs-lookup"><span data-stu-id="cb4a8-114">Defining Private Delegates</span></span>  
  
-   <span data-ttu-id="cb4a8-115">Implementazione di eventi pubblici</span><span class="sxs-lookup"><span data-stu-id="cb4a8-115">Implementing Public Events</span></span>  
  
-   <span data-ttu-id="cb4a8-116">Implementazione del metodo di completamento</span><span class="sxs-lookup"><span data-stu-id="cb4a8-116">Implementing the Completion Method</span></span>  
  
-   <span data-ttu-id="cb4a8-117">Implementazione dei metodi di lavoro</span><span class="sxs-lookup"><span data-stu-id="cb4a8-117">Implementing the Worker Methods</span></span>  
  
-   <span data-ttu-id="cb4a8-118">Implementazione di avvio e i metodi di annullamento</span><span class="sxs-lookup"><span data-stu-id="cb4a8-118">Implementing Start and Cancel Methods</span></span>  
  
 <span data-ttu-id="cb4a8-119">Per copiare il codice in questo argomento come elenco singolo, vedere [procedura: implementare un componente che supporta il modello asincrono basato su eventi](../../../docs/standard/asynchronous-programming-patterns/component-that-supports-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="cb4a8-119">To copy the code in this topic as a single listing, see [How to: Implement a Component That Supports the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/component-that-supports-the-event-based-asynchronous-pattern.md).</span></span>  
  
## <a name="creating-the-component"></a><span data-ttu-id="cb4a8-120">Creazione del componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-120">Creating the Component</span></span>  
 <span data-ttu-id="cb4a8-121">Il primo passaggio consiste nel creare il componente che consente di implementare il modello asincrono basato su eventi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-121">The first step is to create the component that will implement the Event-based Asynchronous Pattern.</span></span>  
  
#### <a name="to-create-the-component"></a><span data-ttu-id="cb4a8-122">Per creare il componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-122">To create the component</span></span>  
  
-   <span data-ttu-id="cb4a8-123">Creare una classe denominata `PrimeNumberCalculator` che eredita da <xref:System.ComponentModel.Component>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-123">Create a class called `PrimeNumberCalculator` that inherits from <xref:System.ComponentModel.Component>.</span></span>  
  
## <a name="defining-public-asynchronous-events-and-delegates"></a><span data-ttu-id="cb4a8-124">Definizione di delegati e gli eventi asincroni pubblici</span><span class="sxs-lookup"><span data-stu-id="cb4a8-124">Defining Public Asynchronous Events and Delegates</span></span>  
 <span data-ttu-id="cb4a8-125">Il componente comunica con i client che usano gli eventi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-125">Your component communicates to clients using events.</span></span> <span data-ttu-id="cb4a8-126">Il *NomeMetodo* `Completed` avvisa i client per il completamento di un'attività asincrona e *NomeMetodo* `ProgressChanged` evento informa dello stato di avanzamento di un'attività asincrona.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-126">The *MethodName*`Completed` event alerts clients to the completion of an asynchronous task, and the *MethodName*`ProgressChanged` event informs clients of the progress of an asynchronous task.</span></span>  
  
#### <a name="to-define-asynchronous-events-for-clients-of-your-component"></a><span data-ttu-id="cb4a8-127">Per definire gli eventi asincroni per i client del componente:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-127">To define asynchronous events for clients of your component:</span></span>  
  
1.  <span data-ttu-id="cb4a8-128">Importazione di <xref:System.Threading?displayProperty=nameWithType> e <xref:System.Collections.Specialized?displayProperty=nameWithType> gli spazi dei nomi nella parte superiore del file.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-128">Import the <xref:System.Threading?displayProperty=nameWithType> and <xref:System.Collections.Specialized?displayProperty=nameWithType> namespaces at the top of your file.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#11](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#11)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#11](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#11)]  
  
2.  <span data-ttu-id="cb4a8-129">Prima di `PrimeNumberCalculator` definizione di classe dichiarare i delegati per gli eventi di stato di avanzamento e il completamento.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-129">Before the `PrimeNumberCalculator` class definition, declare delegates for progress and completion events.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#7](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#7)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#7](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#7)]  
  
3.  <span data-ttu-id="cb4a8-130">Nel `PrimeNumberCalculator` definizione di classe, dichiarare gli eventi per segnalare lo stato di avanzamento e completamento per i client.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-130">In the `PrimeNumberCalculator` class definition, declare events for reporting progress and completion to clients.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#8](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#8)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#8](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#8)]  
  
4.  <span data-ttu-id="cb4a8-131">Dopo il `PrimeNumberCalculator` definizione di classe, derivare la `CalculatePrimeCompletedEventArgs` classe per la segnalazione sul risultato di ogni calcolo al gestore eventi del client per il `CalculatePrimeCompleted`Event.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-131">After the `PrimeNumberCalculator` class definition, derive the `CalculatePrimeCompletedEventArgs` class for reporting the outcome of each calculation to the client's event handler for the `CalculatePrimeCompleted`.event.</span></span> <span data-ttu-id="cb4a8-132">Oltre al `AsyncCompletedEventArgs` proprietà, questa classe consente al client di determinare il numero è stato testato, se si tratta di un numero primo e che cos'è il divisore prima se non è principale.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-132">In addition to the `AsyncCompletedEventArgs` properties, this class enables the client to determine what number was tested, whether it is prime, and what the first divisor is if it is not prime.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#6](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#6)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#6](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#6)]  
  
## <a name="checkpoint"></a><span data-ttu-id="cb4a8-133">Checkpoint</span><span class="sxs-lookup"><span data-stu-id="cb4a8-133">Checkpoint</span></span>  
 <span data-ttu-id="cb4a8-134">A questo punto, è possibile compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-134">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="cb4a8-135">Per testare il componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-135">To test your component</span></span>  
  
-   <span data-ttu-id="cb4a8-136">Compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-136">Compile the component.</span></span>  
  
     <span data-ttu-id="cb4a8-137">Verranno visualizzati due avvisi del compilatore:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-137">You will receive two compiler warnings:</span></span>  
  
    ```  
    warning CS0067: The event 'AsynchronousPatternExample.PrimeNumberCalculator.ProgressChanged' is never used  
    warning CS0067: The event 'AsynchronousPatternExample.PrimeNumberCalculator.CalculatePrimeCompleted' is never used  
    ```  
  
     <span data-ttu-id="cb4a8-138">Nella sezione successiva verranno cancellati tali avvisi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-138">These warnings will be cleared in the next section.</span></span>  
  
## <a name="defining-private-delegates"></a><span data-ttu-id="cb4a8-139">Definizione di delegati privati</span><span class="sxs-lookup"><span data-stu-id="cb4a8-139">Defining Private Delegates</span></span>  
 <span data-ttu-id="cb4a8-140">Gli aspetti di asincrona di `PrimeNumberCalculator` componente sono implementate internamente con un delegato speciale noto come un <xref:System.Threading.SendOrPostCallback>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-140">The asynchronous aspects of the `PrimeNumberCalculator` component are implemented internally with a special delegate known as a <xref:System.Threading.SendOrPostCallback>.</span></span> <span data-ttu-id="cb4a8-141">Oggetto <xref:System.Threading.SendOrPostCallback> rappresenta un metodo di callback che viene eseguito in un <xref:System.Threading.ThreadPool> thread.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-141">A <xref:System.Threading.SendOrPostCallback> represents a callback method that executes on a <xref:System.Threading.ThreadPool> thread.</span></span> <span data-ttu-id="cb4a8-142">Il metodo di callback deve avere una firma che accetta un solo parametro di tipo <xref:System.Object>, pertanto sarà necessario passare lo stato tra i delegati in una classe wrapper.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-142">The callback method must have a signature that takes a single parameter of type <xref:System.Object>, which means you will need to pass state among delegates in a wrapper class.</span></span> <span data-ttu-id="cb4a8-143">Per altre informazioni, vedere <xref:System.Threading.SendOrPostCallback>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-143">For more information, see <xref:System.Threading.SendOrPostCallback>.</span></span>  
  
#### <a name="to-implement-your-components-internal-asynchronous-behavior"></a><span data-ttu-id="cb4a8-144">Per implementare il comportamento asincrono interno del componente:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-144">To implement your component's internal asynchronous behavior:</span></span>  
  
1.  <span data-ttu-id="cb4a8-145">Dichiarare e creare il <xref:System.Threading.SendOrPostCallback> dei delegati nel `PrimeNumberCalculator` classe.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-145">Declare and create the <xref:System.Threading.SendOrPostCallback> delegates in the `PrimeNumberCalculator` class.</span></span> <span data-ttu-id="cb4a8-146">Creare il <xref:System.Threading.SendOrPostCallback> gli oggetti di un metodo di utilità denominati `InitializeDelegates`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-146">Create the <xref:System.Threading.SendOrPostCallback> objects in a utility method called `InitializeDelegates`.</span></span>  
  
     <span data-ttu-id="cb4a8-147">Sono necessari due delegati: uno per i report di stato al client e uno per in fase di completamento al client.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-147">You will need two delegates: one for reporting progress to the client, and one for reporting completion to the client.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#9](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#9)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#9](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#9)]  
    [!code-csharp[System.ComponentModel.AsyncOperationManager#20](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#20)]
    [!code-vb[System.ComponentModel.AsyncOperationManager#20](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#20)]  
  
2.  <span data-ttu-id="cb4a8-148">Chiamare il `InitializeDelegates` metodo nel costruttore del componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-148">Call the `InitializeDelegates` method in your component's constructor.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#21](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#21)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#21](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#21)]  
  
3.  <span data-ttu-id="cb4a8-149">Dichiarare un delegato di `PrimeNumberCalculator` classe che gestisce il lavoro effettivo da eseguire in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-149">Declare a delegate in the `PrimeNumberCalculator` class that handles the actual work to be done asynchronously.</span></span> <span data-ttu-id="cb4a8-150">Questo delegato il wrapping del metodo di lavoro che controlla se un numero è primo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-150">This delegate wraps the worker method that tests whether a number is prime.</span></span> <span data-ttu-id="cb4a8-151">Il delegato accetta un <xref:System.ComponentModel.AsyncOperation> parametro, che verrà utilizzato per tenere traccia della durata dell'operazione asincrona.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-151">The delegate takes an <xref:System.ComponentModel.AsyncOperation> parameter, which will be used to track the lifetime of the asynchronous operation.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#22](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#22)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#22](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#22)]  
  
4.  <span data-ttu-id="cb4a8-152">Creare una raccolta per la gestione di durata delle operazioni asincrone in sospeso.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-152">Create a collection for managing lifetimes of pending asynchronous operations.</span></span> <span data-ttu-id="cb4a8-153">Il client è necessario un modo per tenere traccia delle operazioni vengono eseguite e completati e il rilevamento viene eseguito tramite la richiesta client passare un token univoco o un ID attività, quando il client effettua la chiamata al metodo asincrono.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-153">The client needs a way to track operations as they are executed and completed, and this tracking is done by requiring the client to pass a unique token, or task ID, when the client makes the call to the asynchronous method.</span></span> <span data-ttu-id="cb4a8-154">Il `PrimeNumberCalculator` componente deve tenere traccia di ogni chiamata associando l'ID attività corrispondente chiamata.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-154">The `PrimeNumberCalculator` component must keep track of each call by associating the task ID with its corresponding invocation.</span></span> <span data-ttu-id="cb4a8-155">Se il client passa un ID attività non è univoco, il `PrimeNumberCalculator` componente deve generare un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-155">If the client passes a task ID that is not unique, the `PrimeNumberCalculator` component must raise an exception.</span></span>  
  
     <span data-ttu-id="cb4a8-156">Il `PrimeNumberCalculator` componente tiene traccia dell'ID attività utilizzando una classe di raccolta speciale denominata un <xref:System.Collections.Specialized.HybridDictionary>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-156">The `PrimeNumberCalculator` component keeps track of task ID by using a special collection class called a <xref:System.Collections.Specialized.HybridDictionary>.</span></span> <span data-ttu-id="cb4a8-157">Nella definizione della classe, creare un <xref:System.Collections.Specialized.HybridDictionary> chiamato `userTokenToLifetime`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-157">In the class definition, create a <xref:System.Collections.Specialized.HybridDictionary> called `userTokenToLifetime`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#23](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#23)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#23](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#23)]  
  
## <a name="implementing-public-events"></a><span data-ttu-id="cb4a8-158">Implementazione di eventi pubblici</span><span class="sxs-lookup"><span data-stu-id="cb4a8-158">Implementing Public Events</span></span>  
 <span data-ttu-id="cb4a8-159">I componenti che implementano il modello asincrono basato su eventi comunicano ai client mediante gli eventi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-159">Components that implement the Event-based Asynchronous Pattern communicate to clients using events.</span></span> <span data-ttu-id="cb4a8-160">Questi eventi vengono richiamati sul thread appropriato con l'aiuto del <xref:System.ComponentModel.AsyncOperation> classe.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-160">These events are invoked on the proper thread with the help of the <xref:System.ComponentModel.AsyncOperation> class.</span></span>  
  
#### <a name="to-raise-events-to-your-components-clients"></a><span data-ttu-id="cb4a8-161">Per generare eventi per i client del componente:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-161">To raise events to your component's clients:</span></span>  
  
1.  <span data-ttu-id="cb4a8-162">Implementare gli eventi pubblici per i report ai client.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-162">Implement public events for reporting to clients.</span></span> <span data-ttu-id="cb4a8-163">È necessario un evento per segnalare lo stato di avanzamento e uno per il completamento di creazione di report.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-163">You will need an event for reporting progress and one for reporting completion.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#24](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#24)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#24](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#24)]  
  
## <a name="implementing-the-completion-method"></a><span data-ttu-id="cb4a8-164">Implementazione del metodo di completamento</span><span class="sxs-lookup"><span data-stu-id="cb4a8-164">Implementing the Completion Method</span></span>  
 <span data-ttu-id="cb4a8-165">Il delegato di completamento è il metodo che verrà richiamato il comportamento sottostante, a thread libero asincrono al completamento dell'operazione asincrona per il completamento, errore o annullamento.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-165">The completion delegate is the method that the underlying, free-threaded asynchronous behavior will invoke when the asynchronous operation ends by successful completion, error, or cancellation.</span></span> <span data-ttu-id="cb4a8-166">Questa chiamata si verifica su un thread arbitrario.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-166">This invocation happens on an arbitrary thread.</span></span>  
  
 <span data-ttu-id="cb4a8-167">Questo metodo è in un ID attività del client viene rimosso dalla raccolta interna di token client univoci.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-167">This method is where the client's task ID is removed from the internal collection of unique client tokens.</span></span> <span data-ttu-id="cb4a8-168">Questo metodo termina il ciclo di vita di una determinata operazione asincrona chiamando il <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> metodo sull'oggetto corrispondente <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-168">This method also ends the lifetime of a particular asynchronous operation by calling the <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> method on the corresponding <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="cb4a8-169">Questa chiamata genera l'evento di completamento sul thread appropriato per il modello di applicazione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-169">This call raises the completion event on the thread that is appropriate for the application model.</span></span> <span data-ttu-id="cb4a8-170">Dopo il <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> metodo viene chiamato, l'istanza di <xref:System.ComponentModel.AsyncOperation> non può più essere utilizzato, e tutti i tentativi successivi di usarlo genererà un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-170">After the <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> method is called, this instance of <xref:System.ComponentModel.AsyncOperation> can no longer be used, and any subsequent attempts to use it will throw an exception.</span></span>  
  
 <span data-ttu-id="cb4a8-171">Il `CompletionMethod` firma deve contenere tutti gli stati necessari per descrivere il risultato dell'operazione asincrona.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-171">The `CompletionMethod` signature must hold all state necessary to describe the outcome of the asynchronous operation.</span></span> <span data-ttu-id="cb4a8-172">Contiene lo stato per il numero che è stato testato da questa specifica operazione asincrona, se il numero è primo e il valore del primo divisore se non è un numero primo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-172">It holds state for the number that was tested by this particular asynchronous operation, whether the number is prime, and the value of its first divisor if it is not a prime number.</span></span> <span data-ttu-id="cb4a8-173">Contiene inoltre che descrive le eccezioni che si sono verificati, stato e <xref:System.ComponentModel.AsyncOperation> corrispondente a questa particolare attività.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-173">It also holds state describing any exception that occurred, and the <xref:System.ComponentModel.AsyncOperation> corresponding to this particular task.</span></span>  
  
#### <a name="to-complete-an-asynchronous-operation"></a><span data-ttu-id="cb4a8-174">Per completare un'operazione asincrona:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-174">To complete an asynchronous operation:</span></span>  
  
-   <span data-ttu-id="cb4a8-175">Implementare il metodo di completamento.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-175">Implement the completion method.</span></span> <span data-ttu-id="cb4a8-176">Accetta sei parametri, che viene utilizzato per popolare un `CalculatePrimeCompletedEventArgs` che viene restituito al client tramite il client `CalculatePrimeCompletedEventHandler`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-176">It takes six parameters, which it uses to populate a `CalculatePrimeCompletedEventArgs` that is returned to the client through the client's `CalculatePrimeCompletedEventHandler`.</span></span> <span data-ttu-id="cb4a8-177">L'ID attività del client viene rimosso dalla raccolta interna e termina la durata dell'operazione asincrona con una chiamata a <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-177">It removes the client's task ID token from the internal collection, and it ends the asynchronous operation's lifetime with a call to <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A>.</span></span> <span data-ttu-id="cb4a8-178">Il <xref:System.ComponentModel.AsyncOperation> effettua il marshalling di chiamate al thread o contesto adeguato per il modello di applicazione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-178">The <xref:System.ComponentModel.AsyncOperation> marshals the call to the thread or context that is appropriate for the application model.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#26](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#26)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#26](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#26)]  
  
## <a name="checkpoint"></a><span data-ttu-id="cb4a8-179">Checkpoint</span><span class="sxs-lookup"><span data-stu-id="cb4a8-179">Checkpoint</span></span>  
 <span data-ttu-id="cb4a8-180">A questo punto, è possibile compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-180">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="cb4a8-181">Per testare il componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-181">To test your component</span></span>  
  
-   <span data-ttu-id="cb4a8-182">Compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-182">Compile the component.</span></span>  
  
     <span data-ttu-id="cb4a8-183">Si riceverà un avviso del compilatore:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-183">You will receive one compiler warning:</span></span>  
  
    ```  
    warning CS0169: The private field 'AsynchronousPatternExample.PrimeNumberCalculator.workerDelegate' is never used  
    ```  
  
     <span data-ttu-id="cb4a8-184">Questo avviso verrà risolto nella sezione successiva.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-184">This warning will be resolved in the next section.</span></span>  
  
## <a name="implementing-the-worker-methods"></a><span data-ttu-id="cb4a8-185">Implementazione dei metodi di lavoro</span><span class="sxs-lookup"><span data-stu-id="cb4a8-185">Implementing the Worker Methods</span></span>  
 <span data-ttu-id="cb4a8-186">Finora è stato implementato il codice asincrono di supporto per il `PrimeNumberCalculator` componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-186">So far, you have implemented the supporting asynchronous code for the `PrimeNumberCalculator` component.</span></span> <span data-ttu-id="cb4a8-187">Ora è possibile implementare il codice che esegue il lavoro effettivo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-187">Now you can implement the code that does the actual work.</span></span> <span data-ttu-id="cb4a8-188">Verranno implementati tre metodi: `CalculateWorker`, `BuildPrimeNumberList`, e `IsPrime`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-188">You will implement three methods: `CalculateWorker`, `BuildPrimeNumberList`, and `IsPrime`.</span></span> <span data-ttu-id="cb4a8-189">Insieme, `BuildPrimeNumberList` e `IsPrime` costituiscono un noto algoritmo crivello di Eratostene, che determina se un numero è primo mediante la ricerca di tutti i numeri primi fino alla radice quadrata del numero di test.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-189">Together, `BuildPrimeNumberList` and `IsPrime` comprise a well-known algorithm called the Sieve of Eratosthenes, which determines if a number is prime by finding all the prime numbers up to the square root of the test number.</span></span> <span data-ttu-id="cb4a8-190">Se non vengono individuati divisori di tale punto, il numero di test è un numero primo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-190">If no divisors are found by that point, the test number is prime.</span></span>  
  
 <span data-ttu-id="cb4a8-191">Se questo componente sono state scritte per ottenere la massima efficienza, avrebbe tenuto traccia di tutti i numeri primi individuati da varie chiamate per i numeri di test diversi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-191">If this component were written for maximum efficiency, it would remember all the prime numbers discovered by various invocations for different test numbers.</span></span> <span data-ttu-id="cb4a8-192">È necessario anche triviali come 2, 3 e 5.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-192">It would also check for trivial divisors like 2, 3, and 5.</span></span> <span data-ttu-id="cb4a8-193">Lo scopo di questo esempio è dimostrare come tempo operazioni possono essere eseguite in modo asincrono, tuttavia, in modo da queste ottimizzazioni vengono lasciate come un esercizio per l'utente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-193">The intent of this example is to demonstrate how time-consuming operations can be executed asynchronously, however, so these optimizations are left as an exercise for you.</span></span>  
  
 <span data-ttu-id="cb4a8-194">Il `CalculateWorker` metodo viene eseguito il wrapping in un delegato e viene richiamato in modo asincrono con una chiamata a `BeginInvoke`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-194">The `CalculateWorker` method is wrapped in a delegate and is invoked asynchronously with a call to `BeginInvoke`.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="cb4a8-195">Report di stato viene implementato nel `BuildPrimeNumberList` metodo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-195">Progress reporting is implemented in the `BuildPrimeNumberList` method.</span></span> <span data-ttu-id="cb4a8-196">Nei computer veloci, `ProgressChanged` eventi possono essere generati in rapida successione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-196">On fast computers, `ProgressChanged` events can be raised in rapid succession.</span></span> <span data-ttu-id="cb4a8-197">Il thread del client, in cui vengono generati, deve essere in grado di gestire questa situazione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-197">The client thread, on which these events are raised, must be able to handle this situation.</span></span> <span data-ttu-id="cb4a8-198">Codice dell'interfaccia utente potrebbe essere sovraccaricato dai messaggi e non è possibile tenere il passo, giungendo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-198">User interface code may be flooded with messages and unable to keep up, resulting in hanging behavior.</span></span> <span data-ttu-id="cb4a8-199">Per un esempio di interfaccia utente che gestisce questa situazione, vedere [procedura: implementare un Client del modello asincrono basato su eventi](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="cb4a8-199">For an example user interface that handles this situation, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
#### <a name="to-execute-the-prime-number-calculation-asynchronously"></a><span data-ttu-id="cb4a8-200">Per eseguire in modo asincrono il calcolo dei numeri primi:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-200">To execute the prime number calculation asynchronously:</span></span>  
  
1.  <span data-ttu-id="cb4a8-201">Implementare il `TaskCanceled` metodo di utilità.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-201">Implement the `TaskCanceled` utility method.</span></span> <span data-ttu-id="cb4a8-202">Questo controlla la raccolta di durata di attività per l'ID attività specificato e restituisce `true` se non viene trovato l'ID attività.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-202">This checks the task lifetime collection for the given task ID, and returns `true` if the task ID is not found.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#32](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#32)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#32](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#32)]  
  
2.  <span data-ttu-id="cb4a8-203">Implementare il metodo `CalculateWorker`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-203">Implement the `CalculateWorker` method.</span></span> <span data-ttu-id="cb4a8-204">Il metodo accetta due parametri: un numero di test e un <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-204">It takes two parameters: a number to test, and an <xref:System.ComponentModel.AsyncOperation>.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#27](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#27)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#27](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#27)]  
  
3.  <span data-ttu-id="cb4a8-205">Implementare `BuildPrimeNumberList`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-205">Implement `BuildPrimeNumberList`.</span></span> <span data-ttu-id="cb4a8-206">Il metodo accetta due parametri: il numero di test e un <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-206">It takes two parameters: the number to test, and an <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="cb4a8-207">Usa il <xref:System.ComponentModel.AsyncOperation> per segnalare lo stato e sui risultati incrementali.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-207">It uses the <xref:System.ComponentModel.AsyncOperation> to report progress and incremental results.</span></span> <span data-ttu-id="cb4a8-208">Ciò assicura che i gestori di eventi del client vengono chiamati nel thread appropriato o contesto per il modello di applicazione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-208">This assures that the client's event handlers are called on the proper thread or context for the application model.</span></span> <span data-ttu-id="cb4a8-209">Quando `BuildPrimeNumberList` trova un numero primo, segnala questo come un risultato incrementale al gestore eventi del client per il `ProgressChanged` evento.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-209">When `BuildPrimeNumberList` finds a prime number, it reports this as an incremental result to the client's event handler for the `ProgressChanged` event.</span></span> <span data-ttu-id="cb4a8-210">È richiesta una classe derivata da <xref:System.ComponentModel.ProgressChangedEventArgs>, denominato `CalculatePrimeProgressChangedEventArgs`, che è una proprietà aggiuntiva `LatestPrimeNumber`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-210">This requires a class derived from <xref:System.ComponentModel.ProgressChangedEventArgs>, called `CalculatePrimeProgressChangedEventArgs`, which has one added property called `LatestPrimeNumber`.</span></span>  
  
     <span data-ttu-id="cb4a8-211">Il `BuildPrimeNumberList` metodo chiama anche periodicamente il `TaskCanceled` metodo e viene chiusa se il metodo restituisce `true`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-211">The `BuildPrimeNumberList` method also periodically calls the `TaskCanceled` method and exits if the method returns `true`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#5](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#5)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#5](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#5)]  
  
4.  <span data-ttu-id="cb4a8-212">Implementare `IsPrime`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-212">Implement `IsPrime`.</span></span> <span data-ttu-id="cb4a8-213">Il metodo accetta tre parametri: un elenco di numeri primi noti, il numero di test e un parametro di output per il primo divisore trovato.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-213">It takes three parameters: a list of known prime numbers, the number to test, and an output parameter for the first divisor found.</span></span> <span data-ttu-id="cb4a8-214">Dato l'elenco di numeri primi, determina se il numero di test è un numero primo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-214">Given the list of prime numbers, it determines if the test number is prime.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#28](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#28)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#28](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#28)]  
  
5.  <span data-ttu-id="cb4a8-215">Derivare `CalculatePrimeProgressChangedEventArgs` da <xref:System.ComponentModel.ProgressChangedEventArgs>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-215">Derive `CalculatePrimeProgressChangedEventArgs` from <xref:System.ComponentModel.ProgressChangedEventArgs>.</span></span> <span data-ttu-id="cb4a8-216">Questa classe è necessaria per i report sui risultati incrementali al gestore eventi del client per il `ProgressChanged` evento.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-216">This class is necessary for reporting incremental results to the client's event handler for the `ProgressChanged` event.</span></span> <span data-ttu-id="cb4a8-217">Contiene una proprietà aggiuntiva denominata `LatestPrimeNumber`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-217">It has one added property called `LatestPrimeNumber`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#29](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#29)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#29](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#29)]  
  
## <a name="checkpoint"></a><span data-ttu-id="cb4a8-218">Checkpoint</span><span class="sxs-lookup"><span data-stu-id="cb4a8-218">Checkpoint</span></span>  
 <span data-ttu-id="cb4a8-219">A questo punto, è possibile compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-219">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="cb4a8-220">Per testare il componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-220">To test your component</span></span>  
  
-   <span data-ttu-id="cb4a8-221">Compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-221">Compile the component.</span></span>  
  
     <span data-ttu-id="cb4a8-222">Gli unici elementi ancora da scrivere è i metodi di avvio e annullamento di operazioni asincrone, `CalculatePrimeAsync` e `CancelAsync`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-222">All that remains to be written are the methods to start and cancel asynchronous operations, `CalculatePrimeAsync` and `CancelAsync`.</span></span>  
  
## <a name="implementing-the-start-and-cancel-methods"></a><span data-ttu-id="cb4a8-223">Implementazione dei metodi di annullamento e di avvio</span><span class="sxs-lookup"><span data-stu-id="cb4a8-223">Implementing the Start and Cancel Methods</span></span>  
 <span data-ttu-id="cb4a8-224">Per avviare il metodo di lavoro nel proprio thread, è possibile chiamare `BeginInvoke` sul delegato che lo contiene.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-224">You start the worker method on its own thread by calling `BeginInvoke` on the delegate that wraps it.</span></span> <span data-ttu-id="cb4a8-225">Per gestire la durata di una determinata operazione asincrona, si chiama il <xref:System.ComponentModel.AsyncOperationManager.CreateOperation%2A> metodo la <xref:System.ComponentModel.AsyncOperationManager> classe helper.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-225">To manage the lifetime of a particular asynchronous operation, you call the <xref:System.ComponentModel.AsyncOperationManager.CreateOperation%2A> method on the <xref:System.ComponentModel.AsyncOperationManager> helper class.</span></span> <span data-ttu-id="cb4a8-226">Restituisce un <xref:System.ComponentModel.AsyncOperation>, che effettua il marshalling delle chiamate sui gestori di eventi del client per il thread o contesto appropriato.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-226">This returns an <xref:System.ComponentModel.AsyncOperation>, which marshals calls on the client's event handlers to the proper thread or context.</span></span>  
  
 <span data-ttu-id="cb4a8-227">Per annullare una determinata operazione in sospeso chiamando <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> sull'oggetto corrispondente <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-227">You cancel a particular pending operation by calling <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> on its corresponding <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="cb4a8-228">Verrà terminata l'operazione e tutte le chiamate successive al relativo <xref:System.ComponentModel.AsyncOperation> genererà un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-228">This ends that operation, and any subsequent calls to its <xref:System.ComponentModel.AsyncOperation> will throw an exception.</span></span>  
  
#### <a name="to-implement-start-and-cancel-functionality"></a><span data-ttu-id="cb4a8-229">Per implementare l'inizio e funzionalità di annullamento:</span><span class="sxs-lookup"><span data-stu-id="cb4a8-229">To implement Start and Cancel functionality:</span></span>  
  
1.  <span data-ttu-id="cb4a8-230">Implementare il metodo `CalculatePrimeAsync`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-230">Implement the `CalculatePrimeAsync` method.</span></span> <span data-ttu-id="cb4a8-231">Verificare che il token fornito dal client (ID attività) sia univoco rispetto a tutti i token che rappresenta attualmente attività in sospeso.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-231">Make sure the client-supplied token (task ID) is unique with respect to all the tokens representing currently pending tasks.</span></span> <span data-ttu-id="cb4a8-232">Se il client passa un token non univoco, `CalculatePrimeAsync` genera un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-232">If the client passes in a non-unique token, `CalculatePrimeAsync` raises an exception.</span></span> <span data-ttu-id="cb4a8-233">In caso contrario, il token viene aggiunto alla raccolta di ID attività.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-233">Otherwise, the token is added to the task ID collection.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#3](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#3)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#3](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#3)]  
  
2.  <span data-ttu-id="cb4a8-234">Implementare il metodo `CancelAsync`.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-234">Implement the `CancelAsync` method.</span></span> <span data-ttu-id="cb4a8-235">Se il `taskId` parametro esiste nella raccolta di token, viene rimosso.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-235">If the `taskId` parameter exists in the token collection, it is removed.</span></span> <span data-ttu-id="cb4a8-236">In questo modo non sono stata avviata l'esecuzione delle attività annullate.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-236">This prevents canceled tasks that have not started from running.</span></span> <span data-ttu-id="cb4a8-237">Se l'attività è in esecuzione, il `BuildPrimeNumberList` metodo termina quando viene rilevato che l'ID attività è stato rimosso dalla raccolta durata.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-237">If the task is running, the `BuildPrimeNumberList` method exits when it detects that the task ID has been removed from the lifetime collection.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#4](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#4)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#4](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#4)]  
  
## <a name="checkpoint"></a><span data-ttu-id="cb4a8-238">Checkpoint</span><span class="sxs-lookup"><span data-stu-id="cb4a8-238">Checkpoint</span></span>  
 <span data-ttu-id="cb4a8-239">A questo punto, è possibile compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-239">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="cb4a8-240">Per testare il componente</span><span class="sxs-lookup"><span data-stu-id="cb4a8-240">To test your component</span></span>  
  
-   <span data-ttu-id="cb4a8-241">Compilare il componente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-241">Compile the component.</span></span>  
  
 <span data-ttu-id="cb4a8-242">Il `PrimeNumberCalculator` componente è ora completo e pronto per l'uso.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-242">The `PrimeNumberCalculator` component is now complete and ready to use.</span></span>  
  
 <span data-ttu-id="cb4a8-243">Per un client di esempio che utilizza il `PrimeNumberCalculator` componente, vedere [procedura: implementare un Client del modello asincrono basato su eventi](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="cb4a8-243">For an example client that uses the `PrimeNumberCalculator` component, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
## <a name="next-steps"></a><span data-ttu-id="cb4a8-244">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="cb4a8-244">Next Steps</span></span>  
 <span data-ttu-id="cb4a8-245">È possibile compilare questo esempio scrivendo `CalculatePrime`, l'equivalente di sincrono `CalculatePrimeAsync` metodo.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-245">You can fill out this example by writing `CalculatePrime`, the synchronous equivalent of `CalculatePrimeAsync` method.</span></span> <span data-ttu-id="cb4a8-246">In questo modo il `PrimeNumberCalculator` componente completamente compatibile con il modello asincrono basato su eventi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-246">This will make the `PrimeNumberCalculator` component fully compliant with the Event-based Asynchronous Pattern.</span></span>  
  
 <span data-ttu-id="cb4a8-247">In questo esempio è possibile migliorare mantenendo l'elenco di tutti i numeri primi individuati da varie chiamate per i numeri di test diversi.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-247">You can improve this example by retaining the list of all the prime numbers discovered by various invocations for different test numbers.</span></span> <span data-ttu-id="cb4a8-248">In questo modo, ogni attività trarranno vantaggio dal lavoro svolto dall'attività precedente.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-248">Using this approach, each task will benefit from the work done by previous tasks.</span></span> <span data-ttu-id="cb4a8-249">Assicurarsi di proteggere l'elenco con `lock` aree, pertanto l'accesso all'elenco da thread diversi è serializzato.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-249">Be careful to protect this list with `lock` regions, so access to the list by different threads is serialized.</span></span>  
  
 <span data-ttu-id="cb4a8-250">È inoltre possibile migliorare l'esempio eseguendo il test di divisori semplici, ad esempio 2, 3 e 5.</span><span class="sxs-lookup"><span data-stu-id="cb4a8-250">You can also improve this example by testing for trivial divisors, like 2, 3, and 5.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="cb4a8-251">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="cb4a8-251">See Also</span></span>  
 [<span data-ttu-id="cb4a8-252">Procedura: Eseguire un'operazione in background</span><span class="sxs-lookup"><span data-stu-id="cb4a8-252">How to: Run an Operation in the Background</span></span>](../../../docs/framework/winforms/controls/how-to-run-an-operation-in-the-background.md)  
 [<span data-ttu-id="cb4a8-253">Panoramica sul modello asincrono basato su eventi</span><span class="sxs-lookup"><span data-stu-id="cb4a8-253">Event-based Asynchronous Pattern Overview</span></span>](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md)  
 [<span data-ttu-id="cb4a8-254">NOT IN BUILD: Multithreading in Visual Basic</span><span class="sxs-lookup"><span data-stu-id="cb4a8-254">NOT IN BUILD: Multithreading in Visual Basic</span></span>](http://msdn.microsoft.com/en-us/c731a50c-09c1-4468-9646-54c86b75d269)  
 [<span data-ttu-id="cb4a8-255">Procedura: Implementare un componente che supporta il modello asincrono basato su eventi</span><span class="sxs-lookup"><span data-stu-id="cb4a8-255">How to: Implement a Component That Supports the Event-based Asynchronous Pattern</span></span>](../../../docs/standard/asynchronous-programming-patterns/component-that-supports-the-event-based-asynchronous-pattern.md)  
 [<span data-ttu-id="cb4a8-256">Programmazione multithreading con il modello asincrono basato su eventi</span><span class="sxs-lookup"><span data-stu-id="cb4a8-256">Multithreaded Programming with the Event-based Asynchronous Pattern</span></span>](../../../docs/standard/asynchronous-programming-patterns/multithreaded-programming-with-the-event-based-asynchronous-pattern.md)
